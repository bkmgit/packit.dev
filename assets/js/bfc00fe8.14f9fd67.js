"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[8913],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>g});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function p(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var d=r.createContext({}),l=function(e){var t=r.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):p(p({},t),e)),n},s=function(e){var t=l(e.components);return r.createElement(d.Provider,{value:t},e.children)},c="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,d=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),c=l(n),m=a,g=c["".concat(d,".").concat(m)]||c[m]||u[m]||o;return n?r.createElement(g,p(p({ref:t},s),{},{components:n})):r.createElement(g,p({ref:t},s))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,p=new Array(o);p[0]=m;var i={};for(var d in t)hasOwnProperty.call(t,d)&&(i[d]=t[d]);i.originalType=e,i[c]="string"==typeof e?e:a,p[1]=i;for(var l=2;l<o;l++)p[l]=n[l];return r.createElement.apply(null,p)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},54326:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>p,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var r=n(87462),a=(n(67294),n(3905));const o={title:"PostgreSQL Data Migration"},p="PostgreSQL data migration",i={unversionedId:"postgresql-db-upgrade",id:"postgresql-db-upgrade",title:"PostgreSQL Data Migration",description:"To write out the data from the database pgdumpall command can be used (or pgdump packit to dump only packit",source:"@site/deployment/postgresql-db-upgrade.md",sourceDirName:".",slug:"/postgresql-db-upgrade",permalink:"/deployment/postgresql-db-upgrade",draft:!1,editUrl:"https://github.com/packit/deployment/tree/main/docs/deployment/postgresql-db-upgrade.md",tags:[],version:"current",frontMatter:{title:"PostgreSQL Data Migration"},sidebar:"autogenerated",previous:{title:"Monitoring",permalink:"/deployment/monitoring"},next:{title:"Updating the changelog",permalink:"/deployment/scripts"}},d={},l=[{value:"Upgrade",id:"upgrade",level:2}],s={toc:l},c="wrapper";function u(e){let{components:t,...n}=e;return(0,a.kt)(c,(0,r.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"postgresql-data-migration"},"PostgreSQL data migration"),(0,a.kt)("p",null,"To write out the data from the database ",(0,a.kt)("inlineCode",{parentName:"p"},"pg_dumpall")," command can be used (or ",(0,a.kt)("inlineCode",{parentName:"p"},"pg_dump packit")," to dump only packit\ndatabase). The command creates a file with SQL commands for restoring the database. The only impact of running\n",(0,a.kt)("inlineCode",{parentName:"p"},"pg_dump"),"/",(0,a.kt)("inlineCode",{parentName:"p"},"pg_dumpall")," should be the increased I/O load and the long-running transaction it creates.\nTo import the data ",(0,a.kt)("inlineCode",{parentName:"p"},"psql")," command can be used."),(0,a.kt)("h2",{id:"upgrade"},"Upgrade"),(0,a.kt)("p",null,"When upgrading the database between major versions, the data can be incompatible with the new version."),(0,a.kt)("p",null,"We run Postgres in an Openshift pod, so the process to migrate the data can be to create a new pod (it is important to also\nuse a new PVC in this pod) and then dump the data from the old pod and import them to the new pod:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ oc exec old-postgres-pod -- pg_dumpall -U postgres > dump\n$ oc exec -it new-postgres-pod -- psql -U postgres < dump\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"postgres")," service then needs to be linked to the new pod and the old pod and PVC can be deleted."))}u.isMDXComponent=!0}}]);