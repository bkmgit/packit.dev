"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[457],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>h});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=r.createContext({}),p=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},s=function(e){var t=p(e.components);return r.createElement(c.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=p(n),m=o,h=u["".concat(c,".").concat(m)]||u[m]||d[m]||a;return n?r.createElement(h,i(i({ref:t},s),{},{components:n})):r.createElement(h,i({ref:t},s))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=m;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l[u]="string"==typeof e?e:o,i[1]=l;for(var p=2;p<a;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},34832:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>p});var r=n(87462),o=(n(67294),n(3905));const a={title:"Reproduce CI environment locally",date:new Date("2022-03-01T00:00:00.000Z"),sidebar_position:10},i="Reproduce CI environment locally",l={unversionedId:"reproduce-locally",id:"reproduce-locally",title:"Reproduce CI environment locally",description:"This used to be a question in our FAQ and",source:"@site/docs/reproduce-locally.md",sourceDirName:".",slug:"/reproduce-locally",permalink:"/docs/reproduce-locally",draft:!1,editUrl:"https://github.com/packit/packit.dev/tree/main/docs/reproduce-locally.md",tags:[],version:"current",sidebarPosition:10,frontMatter:{title:"Reproduce CI environment locally",date:"2022-03-01T00:00:00.000Z",sidebar_position:10},sidebar:"autogenerated",previous:{title:"Generated code in upstream archives",permalink:"/docs/archive-not-matching-git"},next:{title:"Service Level Objectives",permalink:"/docs/service-level-objectives"}},c={},p=[{value:"SRPM builds locally",id:"srpm-builds-locally",level:2},{value:"SRPM builds in Copr",id:"srpm-builds-in-copr",level:2},{value:"SRPM builds in our sandbox",id:"srpm-builds-in-our-sandbox",level:2},{value:"Testing Farm",id:"testing-farm",level:2}],s={toc:p},u="wrapper";function d(e){let{components:t,...a}=e;return(0,o.kt)(u,(0,r.Z)({},s,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"reproduce-ci-environment-locally"},"Reproduce CI environment locally"),(0,o.kt)("p",null,"This used to be a question ",(0,o.kt)("a",{parentName:"p",href:"faq#a-command-failed-in-packit-service-how-do-i-reproduce-it-locally"},"in our FAQ")," and\nnow we have a dedicated document to cover this."),(0,o.kt)("h2",{id:"srpm-builds-locally"},"SRPM builds locally"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ packit srpm\n")),(0,o.kt)("p",null,"Packit will create a SRPM out of the current checkout. Simple and clear."),(0,o.kt)("h2",{id:"srpm-builds-in-copr"},"SRPM builds in Copr"),(0,o.kt)("p",null,"When your SRPM is being built in Copr (because ",(0,o.kt)("a",{parentName:"p",href:"configuration/#srpm_build_deps"},(0,o.kt)("inlineCode",{parentName:"a"},"srpm_build_deps"))," is set in your packit config, or\nyou installed Packit GitHub application after September 6, 2022), this\nsection describes how you can reproduce the build procedure locally."),(0,o.kt)("p",null,"We invoke our CLI command ",(0,o.kt)("inlineCode",{parentName:"p"},"packit prepare-sources")," in the Copr environment,\nthe command may look like this for a job triggered by a pull request change:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ packit prepare-sources --result-dir directory-to-place-sources --pr-id 150 \n--merge-pr --target-branch main --job-config-index 2 https://github.com/packit/packit\n")),(0,o.kt)("p",null,"As a first step, you can run this command\nlocally on your computer (if you have installed the needed dependencies for your actions)\nand see whether the sources are correctly prepared."),(0,o.kt)("p",null,"Thankfully, Copr is very transparent how it performs builds. When you open a\nbuild log (e.g. builder-live.log.gz), you'll see a command at the top which\nCopr invokes to perform a build. Let's do that in a container."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ podman run --privileged -ti fedora:36 bash\n")),(0,o.kt)("p",null,"(the reason for running root privileged container is that\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/rpm-software-management/mock"},"mock")," will be used inside and\nneeds capabilities to perform\n",(0,o.kt)("a",{parentName:"p",href:"https://man7.org/linux/man-pages/man1/unshare.1.html"},"unshare"),")"),(0,o.kt)("p",null,"But first we need to install the package which contains the ",(0,o.kt)("inlineCode",{parentName:"p"},"copr-rpmbuild")," command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"[root@f26be2947a15 /]# dnf install -y copr-rpmbuild\n")),(0,o.kt)("p",null,"Now let's rerun locally a build for build-id 3580313:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"[root@f26be2947a15 /]# /usr/bin/copr-rpmbuild --verbose --drop-resultdir --srpm --build-id 3580313\n")),(0,o.kt)("p",null,"Your changes need to be pushed and a PR needs to be created for this to work.\nYou are welcome to experiment with ",(0,o.kt)("inlineCode",{parentName:"p"},"copr-rpmbuild")," to get a more efficient\nworkflow (hint ",(0,o.kt)("inlineCode",{parentName:"p"},"--task-file"),")."),(0,o.kt)("h2",{id:"srpm-builds-in-our-sandbox"},"SRPM builds in our sandbox"),(0,o.kt)("p",null,"Packit by default runs all commands you defined in a\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/packit/sandcastle"},"sandbox")," which is a kubernetes pod in a\nnew project. If you need additional packages or binaries present in the\nsandbox, you should migrate your SRPM builds to be done in Copr using\n",(0,o.kt)("a",{parentName:"p",href:"configuration/#srpm_build_deps"},(0,o.kt)("inlineCode",{parentName:"a"},"srpm_build_deps")),"."),(0,o.kt)("p",null,"You can reproduce our sandbox environment: Firstly, you should pull our\nproduction sandbox image and run commands of your choice inside the container.\nAs an example, this is how we were debugging build problems with anaconda:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Clone your upstream git repo.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Launch the container and bind-mount the upstream project inside:"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ podman run -ti --rm --memory 768MB -v $PWD:/src -w /src quay.io/packit/sandcastle:prod bash\n")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Run commands of your choice:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"[root@4af5dbd9c828 src]# ./configure\nchecking for a BSD-compatible install... /usr/bin/install -c\nchecking whether build environment is sane... yes\nchecking for a thread-safe mkdir -p... /usr/bin/mkdir -p\nchecking for gawk... gawk\nchecking whether make sets $(MAKE)... yes\nchecking whether make supports nested variables... yes\nchecking whether UID '0' is supported by ustar format... yes\nchecking whether GID '0' is supported by ustar format... yes\nchecking how to create a ustar tar archive... gnutar\nchecking whether make supports nested variables... (cached) yes\nchecking whether make supports the include directive... yes (GNU style)\nchecking for gcc... gcc\nchecking whether the C compiler works... yes\n...\n")),(0,o.kt)("p",null,"Our deployment is running in ",(0,o.kt)("a",{parentName:"p",href:"https://docs.openshift.com/rosa/welcome/index.html"},"OpenShift\nROSA"),"."),(0,o.kt)("p",null,"Since OpenShift ",(0,o.kt)("a",{parentName:"p",href:"https://www.openshift.com/blog/a-guide-to-openshift-and-uids"},"invokes pods using arbitrary\nUIDs")," and as you\ncan see, the command above is invoked as root, it does not match production\npackit-service. So, if running a local container didn't help you with\nreproducing the issue, you can try running it in openshift."),(0,o.kt)("p",null,"Here is a simple python code how packit-service does it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'from sandcastle import Sandcastle\n\n# this should be the path to your local clone of the upstream project\ngit_repo_path: str = "fill-me"\n# kubernetes namespace to use\nk8s_namespace: str = "myproject"\ncommand = ["your", "command", "of", "choice"]\n\n# This is how your code gets copied (via rsync) into the openshift pod\nm_dir = MappedDir(git_repo_path, "/sandcastle", with_interim_pvc=True)\n\no = Sandcastle(\n    image_reference="docker.io/usercont/sandcastle:prod",\n    k8s_namespace_name=k8s_namespace,\n    mapped_dir=m_dir\n)\no.run()\ntry:\n    output = o.exec(command=command)\n    print(output)\nfinally:\n    o.delete_pod()\n')),(0,o.kt)("p",null,"This script requires:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/packit/sandcastle"},"sandcastle")," installed"),(0,o.kt)("li",{parentName:"ul"},"being logged in an openshift cluster (",(0,o.kt)("inlineCode",{parentName:"li"},"oc whoami")," to confirm)"),(0,o.kt)("li",{parentName:"ul"},"rsync binary available")),(0,o.kt)("p",null,"If none of these helped you, please ",(0,o.kt)("a",{parentName:"p",href:"/#contact"},"reach out")," to us and we'll try to help you."),(0,o.kt)("h2",{id:"testing-farm"},"Testing Farm"),(0,o.kt)("p",null,"When you open test results, you can see commands which Testing Farm performed\nto run your test. You can run those locally."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Testing Farm Log Output",src:n(92307).Z,width:"987",height:"454"})),(0,o.kt)("p",null,"The team is also planning to have a solution to fully reproduce the CI testing\nprocess locally:\n",(0,o.kt)("a",{parentName:"p",href:"https://github.com/teemtee/tmt/issues/1075"},"teemtee/tmt#1075"),"."))}d.isMDXComponent=!0},92307:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/tf-log-output-cdc5e1387e7ed318ce6abae84bcc62c2.png"}}]);